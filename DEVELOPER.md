# Developer Guide - AWS SPA Hosting Kit

This guide provides detailed information for developers working on the AWS SPA Hosting Kit infrastructure.

## Table of Contents

- [Development Setup](#development-setup)
- [Project Structure](#project-structure)
- [Configuration System](#configuration-system)
- [CDK Stack Architecture](#cdk-stack-architecture)
- [Deployment Process](#deployment-process)
- [Testing Strategy](#testing-strategy)
- [Troubleshooting](#troubleshooting)
- [Contributing](#contributing)

## Development Setup

This document assumes all prerequisites listed in [PREREQUISITES.md](PREREQUISITES.md) are already met.

### Initial Setup

1. **Clone the repository**:
   ```bash
   git clone https://github.com/rusty428/aws-spa-hosting-kit.git
   cd aws-spa-hosting-kit
   ```

2. **Install dependencies**:
   ```bash
   npm install
   ```

3. **Build TypeScript**:
   ```bash
   npm run build
   ```

4. **Configure AWS credentials**:
   ```bash
   aws configure
   ```
   Provide your AWS Access Key ID, Secret Access Key, default region, and output format.

5. **Create configuration file**:
   ```bash
   cp config/config.example.yml config/config.yml
   ```
   Edit `config/config.yml` with your settings.

### Development Workflow

1. **Make changes** to TypeScript source files in `src/`
2. **Build** the project: `npm run build`
3. **Run tests**: `npm test`
4. **Synthesize CloudFormation**: `npx cdk synth`
5. **Deploy to AWS**: `npm run deploy`

### Watch Mode

For active development, use watch mode to automatically recompile on file changes:

```bash
npm run watch
```

## Project Structure

```
aws-spa-hosting-kit/
├── src/                          # TypeScript source code
│   ├── bin/                      # CDK app entry point
│   │   └── app.ts               # Main application file
│   ├── config/                   # Configuration management
│   │   ├── index.ts             # Module exports
│   │   ├── loader.ts            # Config loading and validation
│   │   └── types.ts             # TypeScript interfaces
│   ├── notifications/            # SNS notification management
│   │   ├── index.ts             # Module exports
│   │   └── notification-manager.ts
│   ├── pipeline/                 # CodeBuild and pipeline config
│   │   ├── buildspec-generator.ts
│   │   ├── buildspec-types.ts
│   │   └── index.ts
│   └── stack/                    # CDK stack definitions
│       ├── index.ts
│       └── spa-hosting-stack.ts # Main infrastructure stack
├── lib/                          # Compiled JavaScript output
├── test/                         # Test files
│   ├── unit/                    # Unit tests
│   └── property/                # Property-based tests
├── config/                       # Configuration files
│   ├── config.example.yml       # Example configuration
│   └── config.yml               # User configuration (gitignored)
├── cdk.out/                      # CDK synthesis output
├── .kiro/                        # Kiro IDE specifications
│   └── specs/                   # Feature specifications
├── cdk.json                      # CDK configuration
├── tsconfig.json                 # TypeScript configuration
├── jest.config.js                # Jest test configuration
├── package.json                  # Node.js dependencies and scripts
└── README.md                     # User-facing documentation
```

### Key Directories

- **`src/`**: All TypeScript source code
  - **`bin/`**: CDK application entry point that loads config and creates stacks
  - **`config/`**: Configuration loading, validation, and type definitions
  - **`stack/`**: CDK stack definitions with AWS resource creation
  - **`pipeline/`**: CodeBuild buildspec generation logic
  - **`notifications/`**: SNS topic and subscription management

- **`lib/`**: Compiled JavaScript output (generated by TypeScript compiler)

- **`test/`**: Test suites
  - **`unit/`**: Unit tests for individual components
  - **`property/`**: Property-based tests using fast-check

- **`config/`**: YAML configuration files
  - **`config.example.yml`**: Template with all options documented
  - **`config.yml`**: User's actual configuration (not committed to git)

- **`.kiro/specs/`**: Feature specifications with requirements, design, and tasks

## Configuration System

### Configuration Loading

The `ConfigLoader` class handles all configuration operations:

```typescript
// Load configuration from file
const config = ConfigLoader.load('config/config.yml');

// Validate configuration
const validation = ConfigLoader.validate(config);
if (!validation.valid) {
  console.error('Validation errors:', validation.errors);
}
```

### Configuration Schema

```typescript
interface HostingConfig {
  projectName: string;           // Required: Unique project identifier (namespace/identity key)
  github: {
    repositoryUrl: string;      // Required: GitHub repo URL
    branch?: string;             // Optional: defaults to "main"
  };
  aws: {
    region: string;              // Required: AWS region
    accountId?: string;          // Optional: inferred from credentials
  };
  domain?: {
    customDomain?: string;       // Optional: custom domain name
    certificateArn?: string;     // Required if customDomain set
  };
  notifications?: {
    email?: string;              // Optional: notification email
  };
  build?: {
    outputDirectory?: string;    // Optional: defaults to "dist"
    buildCommand?: string;       // Optional: defaults to "npm run build"
    installCommand?: string;     // Optional: defaults to "npm ci"
  };
}
```

### Default Values

The loader applies these defaults:
- `github.branch`: `"main"`
- `build.outputDirectory`: `"dist"`
- `build.buildCommand`: `"npm run build"`
- `build.installCommand`: `"npm ci"`
- `notifications.email`: `"rusty@example.com"` (maintainer default)

### Validation Rules

1. **Project Name**: Must contain only alphanumeric characters, hyphens, and underscores
2. **GitHub URL**: Must match `https://github.com/{owner}/{repo}`
3. **AWS Region**: Must be a valid AWS region code
4. **Email**: Must be valid email format if provided
5. **Domain**: If `customDomain` is set, `certificateArn` is required
6. **Region Warning**: Warns if not `us-east-1` with custom domain (ACM requirement)

### Important: projectName as Namespace

The `projectName` field serves as a **namespace and identity key** for your infrastructure, not a display name:

- **Purpose**: Uniquely identifies AWS resources (pipeline, connection, SNS topic, etc.)
- **Immutability**: Changing `projectName` creates **new infrastructure**, it does not rename existing resources
- **Naming Convention**: Use descriptive, permanent identifiers (e.g., `my-company-marketing-site`, not `temp-test`)
- **Multi-Deployment**: Different `projectName` values allow multiple SPAs in the same AWS account
- **No Renaming**: To "rename" a project, you must deploy new infrastructure and destroy the old stack

**Example Impact**:
```yaml
# Original deployment
projectName: "my-spa-v1"
# Creates: my-spa-v1-hosting-pipeline, my-spa-v1-github, etc.

# Changing projectName
projectName: "my-spa-v2"
# Creates: NEW resources (my-spa-v2-hosting-pipeline, my-spa-v2-github, etc.)
# Old resources (my-spa-v1-*) remain until you run `cdk destroy`
```

## CDK Stack Architecture

### SpaHostingStack

The main CDK stack creates all AWS resources:

```typescript
export class SpaHostingStack extends cdk.Stack {
  constructor(scope: Construct, id: string, config: HostingConfig);
}
```

### Resource Creation Flow

1. **S3 Bucket** (`createS3Bucket`)
   - Private bucket with `BlockPublicAccess.BLOCK_ALL`
   - S3-managed server-side encryption
   - Auto-delete on stack destruction

2. **CloudFront Distribution** (`createCloudFrontDistribution`)
   - Origin Access Control (OAC) for S3 access
   - HTTPS enforcement with `REDIRECT_TO_HTTPS`
   - Error response mapping (404/403 → index.html)
   - Compression enabled

3. **Source Repository Connection** (`createCodeStarConnection`)
   - OAuth integration via AWS CodeConnections (configured for GitHub by default)
   - Supports GitHub, Bitbucket, GitLab, GitHub Enterprise Server, GitLab self-managed, and Azure DevOps
   - Requires manual authorization post-deployment

4. **CodeBuild Project** (`createCodeBuildProject`)
   - Node.js 20 runtime
   - Generated buildspec from configuration
   - IAM permissions for S3 access

5. **CodePipeline** (`createPipeline`)
   - Source stage: GitHub connection (AWS CodeConnections)
   - Build stage: CodeBuild
   - Deploy stage: S3 deployment

6. **SNS Topic** (`createNotificationTopic`)
   - Conditional creation based on config
   - Email subscription

7. **CloudFront Invalidation** (`setupCloudFrontInvalidation`)
   - Lambda function triggered by pipeline success
   - Invalidates `/*` path

8. **Notification Wiring** (`attachNotificationsToPipeline`)
   - EventBridge rules for pipeline state changes
   - SNS notifications for success/failure

### Stack Outputs

The stack exports these CloudFormation outputs:

- `CloudFrontUrl`: Distribution domain name
- `S3BucketName`: Bucket name for static files
- `PipelineName`: CodePipeline name
- `CodeStarConnectionArn`: GitHub connection ARN (requires authorization)
- `NotificationTopicArn`: SNS topic ARN (if notifications enabled)

## Deployment Process

### CDK Bootstrap

First-time AWS account setup (one-time per account/region):

```bash
npx cdk bootstrap aws://ACCOUNT-ID/REGION
```

This creates the CDK toolkit stack with S3 bucket for assets and IAM roles.

### Deployment Commands

```bash
# Synthesize CloudFormation template (no deployment)
npx cdk synth

# View differences between deployed and local
npm run cdk diff

# Deploy infrastructure
npm run deploy

# Deploy with specific AWS profile
npm run deploy -- --profile YOUR-PROFILE-NAME

# Skip confirmation prompt (for CI/CD)
npm run deploy -- --require-approval never

# Destroy all resources
npm run destroy
```

### Stack Cleanup

To completely remove all infrastructure for a project:

```bash
npm run destroy
```

Or with a specific AWS profile:

```bash
npm run destroy -- --profile YOUR-PROFILE-NAME
```

**What gets deleted:**
- All AWS resources created by the stack (S3, CloudFront, CodePipeline, etc.)
- All data in the S3 bucket (autoDeleteObjects is enabled)
- IAM roles and policies
- SNS topics and subscriptions
- Lambda functions and EventBridge rules

**Deletion time:** 15-20 minutes (CloudFront distribution removal is slow)

**Safety:** Resources are namespaced by `projectName`, so destroying one stack won't affect other deployments in the same account.

### Deployment Confirmation

When you run `npm run deploy`, CDK will display:
1. A detailed table of IAM Statement Changes showing all permissions being created
2. A table of IAM Policy Changes showing managed policies being attached
3. A prompt: `Do you wish to deploy these changes (y/n)?`

This confirmation is required because the stack creates security-sensitive resources (IAM roles, policies, S3 bucket policies, etc.). Review the changes and type `y` to proceed.

### Deployment Stages

1. **Synthesis**: CDK converts TypeScript to CloudFormation JSON
2. **Asset Staging**: Lambda code and buildspecs uploaded to CDK staging bucket
3. **CloudFormation Deployment**: Resources created in AWS
4. **Stack Outputs**: URLs and ARNs displayed in terminal

### Post-Deployment Steps

1. **Authorize Source Repository Connection**:
   - Go to AWS Console → Developer Tools → Settings → Connections
   - Direct link: `https://console.aws.amazon.com/codesuite/settings/connections?region=YOUR-REGION`
   - Replace `YOUR-REGION` with your deployment region
   - Find your connection (named `{projectName}-github`)
   - Click "Update pending connection"
   - Complete OAuth flow with your source code provider (GitHub, Bitbucket, GitLab, etc.)

2. **Confirm SNS Subscription** (if notifications enabled):
   - Check email for AWS SNS subscription confirmation
   - Click confirmation link

3. **Test Pipeline**:
   - Push a commit to your SPA repository
   - Verify pipeline triggers automatically
   - Check CloudFront URL for deployed content

## Testing Strategy

### Test Structure

```
test/
├── unit/                    # Unit tests for individual components
│   ├── config.test.ts      # Configuration loading and validation
│   ├── buildspec.test.ts   # BuildSpec generation
│   └── stack.test.ts       # CDK stack synthesis
└── property/                # Property-based tests
    ├── config.property.ts  # Configuration validation properties
    └── buildspec.property.ts # BuildSpec generation properties
```

### Running Tests

```bash
# Run all tests
npm test

# Run unit tests only
npm run test:unit

# Run property-based tests only
npm run test:property

# Run tests in watch mode
npm test -- --watch

# Run tests with coverage
npm test -- --coverage
```

### Unit Testing

Unit tests verify specific behaviors and edge cases:

```typescript
describe('ConfigLoader', () => {
  it('should load valid configuration', () => {
    const config = ConfigLoader.load('config/config.example.yml');
    expect(config.github.repositoryUrl).toBeDefined();
  });

  it('should reject invalid GitHub URL', () => {
    const config = { github: { repositoryUrl: 'invalid' }, aws: { region: 'us-east-1' } };
    const result = ConfigLoader.validate(config);
    expect(result.valid).toBe(false);
    expect(result.errors).toContain('Invalid GitHub repository URL');
  });
});
```

### Property-Based Testing

Property tests verify universal correctness across many random inputs using `fast-check`:

```typescript
import * as fc from 'fast-check';

describe('Configuration Validation Properties', () => {
  it('should accept all valid configurations', () => {
    fc.assert(
      fc.property(validConfigArbitrary(), (config) => {
        const result = ConfigLoader.validate(config);
        expect(result.valid).toBe(true);
      })
    );
  });
});
```

### CDK Stack Testing

Test CDK stack synthesis without deploying:

```typescript
import * as cdk from 'aws-cdk-lib';
import { Template } from 'aws-cdk-lib/assertions';
import { SpaHostingStack } from '../src/stack/spa-hosting-stack';

test('Stack creates S3 bucket with encryption', () => {
  const app = new cdk.App();
  const stack = new SpaHostingStack(app, 'TestStack', mockConfig);
  const template = Template.fromStack(stack);
  
  template.hasResourceProperties('AWS::S3::Bucket', {
    BucketEncryption: {
      ServerSideEncryptionConfiguration: [
        { ServerSideEncryptionByDefault: { SSEAlgorithm: 'AES256' } }
      ]
    }
  });
});
```

## Troubleshooting

### Common Issues

#### TypeScript Compilation Errors

**Problem**: `tsc` fails with type errors

**Solution**:
```bash
# Clean build artifacts
rm -rf lib/
npm run build
```

#### CDK Synthesis Fails

**Problem**: `npx cdk synth` fails with configuration errors

**Solution**:
1. Validate configuration: Check `config/config.yml` format
2. Check AWS credentials: `aws sts get-caller-identity`
3. Review error messages for specific validation failures

#### CloudFront Distribution Timeout

**Problem**: Deployment fails with `Resource timed out waiting for completion` for CloudFront distribution

**Cause**: CloudFront distributions take 15-30 minutes to create or update. CDK may timeout before completion.

**Solution**:
1. Check AWS Console → CloudFormation → SpaHostingStack for actual status
2. If stack is in `ROLLBACK_FAILED` state:
   ```bash
   # Delete the failed stack from CloudFormation console
   # This takes 20-30 minutes as CloudFront deletes
   # Then retry deployment
   npm run deploy
   ```
3. If CloudFront is still creating, wait for it to complete

**Prevention**: Ensure stable network connection. CloudFront creation cannot be accelerated.

#### Outdated Bootstrap Stack

**Problem**: Warning `Bootstrap stack outdated` (version < 21)

**Solution**:
```bash
npx cdk bootstrap aws://ACCOUNT-ID/REGION --profile YOUR-PROFILE-NAME
```

This updates the CDK toolkit stack to the latest version.

#### Stack Deployment Fails

**Problem**: CloudFormation deployment fails

**Solution**:
1. Check AWS Console → CloudFormation for detailed error
2. Verify IAM permissions for CDK deployment
3. Check for resource limits (e.g., S3 bucket limits)
4. Review CloudFormation events for specific resource failures

#### Pipeline Not Triggering

**Problem**: Repository pushes don't trigger pipeline

**Solution**:
1. Verify connection is authorized (status: AVAILABLE) in Developer Tools → Settings → Connections
2. Check branch name matches configuration
3. Verify repository URL is correct and matches the provider format
4. Check CodePipeline execution history for errors
5. Ensure the connection provider type matches your repository (GitHub, Bitbucket, GitLab, etc.)

#### Build Failures

**Problem**: CodeBuild stage fails

**Solution**:
1. Check CodeBuild logs in AWS Console
2. Verify build commands are correct for your SPA
3. Check output directory matches your framework
4. Verify dependencies are in package.json

### Debugging Tips

1. **Enable CDK Debug Output**:
   ```bash
   npx cdk synth --verbose
   ```

2. **View CloudFormation Template**:
   ```bash
   npx cdk synth > template.json
   ```

3. **Check Stack Drift**:
   ```bash
   aws cloudformation detect-stack-drift --stack-name SpaHostingStack
   ```

4. **View Pipeline Execution**:
   ```bash
   aws codepipeline get-pipeline-execution \
     --pipeline-name spa-hosting-pipeline \
     --pipeline-execution-id <execution-id>
   ```

## Contributing

### Code Standards

- **TypeScript**: Use strict mode, enable all compiler checks
- **Formatting**: Use 2-space indentation, semicolons required
- **Naming**: Use camelCase for variables/functions, PascalCase for classes
- **Comments**: Document public APIs with JSDoc comments
- **Error Handling**: Always provide descriptive error messages

### Development Workflow

1. **Create Feature Branch**:
   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **Make Changes**:
   - Write code in `src/`
   - Add tests in `test/`
   - Update documentation if needed

3. **Test Changes**:
   ```bash
   npm run build
   npm test
   ```

4. **Commit Changes**:
   ```bash
   git add .
   git commit -m "feat: add your feature description"
   ```

5. **Push and Create PR**:
   ```bash
   git push origin feature/your-feature-name
   ```

### Commit Message Format

Follow conventional commits:

- `feat:` New feature
- `fix:` Bug fix
- `docs:` Documentation changes
- `test:` Test additions or changes
- `refactor:` Code refactoring
- `chore:` Maintenance tasks

### Pull Request Guidelines

- Provide clear description of changes
- Include tests for new functionality
- Update documentation as needed
- Ensure all tests pass
- Keep PRs focused on single feature/fix

### Testing Requirements

- All new features must have unit tests
- Property-based tests for validation logic
- CDK stack tests for infrastructure changes
- Maintain >80% code coverage

### Documentation Requirements

- Update README.md for user-facing changes
- Update DEVELOPER.md for developer-facing changes
- Add JSDoc comments for public APIs
- Update configuration examples if schema changes

## Architecture Decisions

### Why Origin Access Control (OAC)?

OAC is the modern AWS-recommended approach for CloudFront-to-S3 security, replacing the legacy Origin Access Identity (OAI). OAC provides:
- Support for S3 bucket encryption with AWS KMS
- Support for dynamic requests to S3
- Better integration with AWS services

### Why AWS CodeConnections?

AWS CodeConnections (formerly CodeStar Connections) provide secure source repository integration without managing personal access tokens or SSH keys. Benefits:
- OAuth-based authentication
- No token rotation required
- Supports multiple providers: GitHub, Bitbucket, GitLab, GitHub Enterprise Server, GitLab self-managed, and Azure DevOps
- Works with private repositories
- Supports GitHub Apps for enhanced security

### Why Separate Infrastructure Repository?

Keeping infrastructure separate from application code provides:
- Independent versioning and deployment
- No changes required to existing SPA repositories
- Reusable infrastructure across multiple SPAs
- Clear separation of concerns

### Why CDK over CloudFormation?

AWS CDK provides:
- Type safety with TypeScript
- IDE autocomplete and refactoring
- Reusable constructs and patterns
- Higher-level abstractions
- Full CloudFormation power when needed

## Related Documentation

- [AWS CDK Documentation](https://docs.aws.amazon.com/cdk/)
- [AWS CodePipeline Documentation](https://docs.aws.amazon.com/codepipeline/)
- [CloudFront Origin Access Control](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-restricting-access-to-s3.html)
- [AWS CodeConnections](https://docs.aws.amazon.com/dtconsole/latest/userguide/welcome-connections.html)

## Contact

For questions or contributions, contact @awsrusty

---

Last updated: 2026-02-10
